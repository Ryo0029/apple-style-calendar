<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>iOS Style Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ---------------------------------------------------
   基本テーマ（ガラス＋iOS17風）
--------------------------------------------------- */
:root {
  --bg: rgba(255,255,255,0.60);
  --fg: #1d1d1f;
  --accent: #0a84ff;
  --card-bg: rgba(255,255,255,0.55);
  --glass-border: rgba(255,255,255,0.35);
}

body.dark {
  --bg: rgba(10,10,10,0.55);
  --fg: #f5f5f7;
  --accent:#0a84ff;
  --card-bg: rgba(20,20,20,0.55);
  --glass-border: rgba(255,255,255,0.28);
}

body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Segoe UI,sans-serif;
  background:var(--bg);
  backdrop-filter: blur(45px);
  color:var(--fg);
  transition:0.25s ease;
}

/* 背景グラデーション（Apple風12色） */
.gradient-bg {
  position: fixed;
  inset: -20%;
  z-index: -1;
  background: linear-gradient(
    120deg,
    #ff4d4d,
    #ff884d,
    #ffd44d,
    #e4ff4d,
    #a9ff4d,
    #4dff88,
    #4dffd4,
    #4dd4ff,
    #4d88ff,
    #4d4dff,
    #884dff,
    #d44dff
  );
  background-size: 400% 400%;
  opacity: 0.35;
  filter: blur(70px);
  animation: appleWave 18s ease-in-out infinite alternate;
  pointer-events: none;
}

@keyframes appleWave {
  0% { background-position: 0% 50%; }
  50% { background-position: 50% 50%; }
  100% { background-position: 100% 50%; }
}

/* ヘッダー */
header {
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.segmented {
  display:inline-flex;
  padding:4px;
  border-radius:999px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  backdrop-filter:blur(25px);
}

.segmented button {
  border:none;
  background:transparent;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  cursor:pointer;
}

.segmented button.active {
  background:var(--accent);
  color:#fff;
}

.header-right {
  display:flex;
  gap:8px;
  align-items:center;
}

#tzButton {
  padding:6px 12px;
  border-radius:20px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
}

#tzSelect {
  padding:6px;
  border-radius:10px;
  border:1px solid var(--glass-border);
}

#modeToggle {
  padding:6px 16px;
  border-radius:20px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
}

/* レイアウト */
.shell {
  display:grid;
  grid-template-columns:38% 62%;
  gap:20px;
  padding:20px;
}

@media (max-width:900px) {
  .shell {
    grid-template-columns:1fr;
  }
}

/* 左パネル：今日情報 */
.left-panel {
  display:flex;
  flex-direction:column;
  gap:20px;
}

.today-hero {
  padding:32px;
  border-radius:24px;
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  backdrop-filter: blur(30px);
  text-align:center;
}

.hero-time {
  font-size:40px;
  font-weight:700;
}

.hero-date {
  margin-top:8px;
  font-size:22px;
  font-weight:600;
}

/* 今日の予定編集 */
.today-notes {
  padding:20px;
  border-radius:20px;
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  backdrop-filter: blur(25px);
}

.notes-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

#addNoteBtn {
  padding:4px 12px;
  border-radius:14px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
}

.note-list {
  display:flex;
  flex-direction:column;
  gap:10px;
}

.note-card {
  padding:10px;
  background:var(--bg);
  border-radius:12px;
  border:1px solid var(--glass-border);
}

.note-row {
  display:flex;
  gap:8px;
  margin-bottom:6px;
}

.note-row input[type="text"],
.note-row input[type="color"],
.note-row input[type="time"] {
  flex:1;
  padding:6px;
  border-radius:10px;
  border:1px solid var(--glass-border);
  background:rgba(255,255,255,0.7);
}

.map-open {
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
  white-space:nowrap;
}

.note-delete {
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
}

/* 右：月カレンダー */
.calendar-panel {
  padding:20px;
  border-radius:22px;
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  backdrop-filter: blur(25px);
}

.calendar-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}

.nav-btn {
  padding:6px 12px;
  border-radius:10px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
}

.nav-group {
  display:flex;
  gap:6px;
  margin-top:8px;
}

#todayBtn {
  margin-top:10px;
}

.calendar-grid {
  margin-top:12px;
  display:grid;
  grid-template-columns:repeat(7, 1fr);
  gap:6px;
}

.day-cell {
  height:110px;
  padding:6px;
  border-radius:12px;
  background:var(--bg);
  border:1px solid var(--glass-border);
  position:relative;
  overflow:hidden;
  font-size:12px;
  cursor:pointer;
}

.day-cell-today {
  border:2px solid var(--accent);
}

.day-cell.selected {
  outline:3px solid var(--accent);
  outline-offset:1px;
}

.day-number {
  font-weight:700;
  margin-bottom:4px;
}

.event-line {
  font-size:11px;
  padding:1px 4px;
  border-radius:4px;
  margin-top:2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  color:white;
}

/* 日ビュー（タイムライン） */
.day-view {
  margin-top:14px;
  border-radius:18px;
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  backdrop-filter: blur(24px);
  padding:6px 10px 8px;
  height:320px;
  position:relative;
  overflow:hidden;
  font-size:11px;
}

.day-view-header {
  font-weight:600;
  margin-bottom:4px;
}

.day-hours {
  position:absolute;
  left:0;
  top:24px;
  bottom:4px;
  width:22%;
  border-right:1px solid rgba(0,0,0,0.15);
}

body.dark .day-hours {
  border-right-color:rgba(255,255,255,0.18);
}

.day-hour-label {
  position:absolute;
  left:4px;
  transform:translateY(-50%);
  font-size:10px;
  opacity:0.7;
}

.day-events-layer {
  position:absolute;
  left:23%;
  right:4px;
  top:24px;
  bottom:4px;
}

.day-event-block {
  position:absolute;
  left:0;
  right:0;
  border-radius:8px;
  padding:2px 4px;
  color:#fff;
  font-size:10px;
  overflow:hidden;
  box-shadow:0 4px 10px rgba(0,0,0,0.25);
}

/* ToDoページ */
#todoPage {
  display:none;
  opacity:1;
  padding:20px;
}

.todo-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

#addTodoBtn {
  padding:4px 12px;
  border-radius:14px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
}

.todo-list {
  display:flex;
  flex-direction:column;
  gap:8px;
}

.todo-item {
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px;
  border-radius:10px;
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  cursor:grab;
}

.todo-item input[type="text"] {
  flex:1;
  padding:6px;
  border-radius:8px;
  border:1px solid var(--glass-border);
  background:rgba(255,255,255,0.7);
}

.todo-delete {
  padding:4px 8px;
  border-radius:8px;
  border:1px solid var(--glass-border);
  background:var(--card-bg);
  cursor:pointer;
}

.todo-item:active {
  cursor:grabbing;
}

/* フェード */
.fade {
  transition:opacity 0.35s ease;
}
</style>
</head>

<body>
<div class="gradient-bg"></div>

<header>
  <!-- CALENDAR / TODO 切替（セグメント風） -->
  <div class="segmented">
    <button id="segCalendar" class="active">Calendar</button>
    <button id="segTodo">ToDo</button>
  </div>

  <div class="header-right">
    <button id="tzButton">Asia/Tokyo</button>
    <select id="tzSelect"></select>
    <button id="modeToggle">Dark</button>
  </div>
</header>

<main>

<!-- ========== カレンダーページ ========== -->
<div id="calendarPage" class="fade">
  <div class="shell">
    <!-- 左パネル -->
    <section class="left-panel">

      <section class="today-hero">
        <div class="hero-time" id="heroTime">00:00</div>
        <div class="hero-date" id="heroDate">2025/01/01</div>
      </section>

      <section class="today-notes">
        <div class="notes-header">
          <strong id="selectedDateLabel">今日の予定</strong>
          <button id="addNoteBtn">＋</button>
        </div>

        <div class="note-list" id="noteList"></div>
      </section>

    </section>

    <!-- 右：月カレンダー＋日ビュー -->
    <section class="calendar-panel">
      <div class="calendar-header">
        <button class="nav-btn" id="prevMonth">←</button>
        <div id="monthLabel" style="font-size:20px;font-weight:700;">2025年1月</div>
        <button class="nav-btn" id="nextMonth">→</button>
      </div>

      <div class="nav-group">
        <button class="nav-btn" id="todayBtn">Today</button>
        <button class="nav-btn" id="prevEventBtn">前の予定</button>
        <button class="nav-btn" id="nextEventBtn">次の予定</button>
      </div>

      <div class="calendar-grid" id="calendarGrid"></div>

    </section>
  </div>
</div>

<!-- ========== ToDoページ ========== -->
<div id="todoPage" class="fade">
  <div class="todo-header">
    <strong>ToDo List</strong>
    <button id="addTodoBtn">＋</button>
  </div>
  <div class="todo-list" id="todoList"></div>
</div>

</main>

<script>
/* ============================================================
   ストレージキー
============================================================ */
const STORAGE_EVENTS = "events";
const STORAGE_TODO   = "todo_v1";
const STORAGE_PREFS  = "prefs_v1";

/* ============================================================
   イベント構造
============================================================ */
function createEvent() {
  return {
    id: crypto.randomUUID(),
    title: "",
    location: { name: "", lat: null, lng: null },
    notes: "",
    color: "#3478F6",
    allDay: false,
    start: "",      // "YYYY-MM-DD"
    end: "",        // 拡張用
    startTime: "",  // "HH:MM"
    endTime: ""     // "HH:MM"
  };
}

function loadEvents() {
  return JSON.parse(localStorage.getItem(STORAGE_EVENTS) || "[]");
}
function saveEvents(arr) {
  localStorage.setItem(STORAGE_EVENTS, JSON.stringify(arr));
}

/* ============================================================
   ToDo ストレージ
============================================================ */
function loadTodo() {
  return JSON.parse(localStorage.getItem(STORAGE_TODO) || "[]");
}
function saveTodo(arr) {
  localStorage.setItem(STORAGE_TODO, JSON.stringify(arr));
}

/* ============================================================
   プリファレンス
============================================================ */
function loadPrefs() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_PREFS) || "{}");
  } catch {
    return {};
  }
}
function savePrefs(prefs) {
  localStorage.setItem(STORAGE_PREFS, JSON.stringify(prefs));
}

let prefs = loadPrefs();

/* ============================================================
   カレンダー状態
============================================================ */
const nowInit = new Date();
let viewYear  = typeof prefs.viewYear  === "number" ? prefs.viewYear  : nowInit.getFullYear();
let viewMonth = typeof prefs.viewMonth === "number" ? prefs.viewMonth : nowInit.getMonth();
let selectedDate = prefs.selectedDate || nowInit.toISOString().slice(0,10);
let currentTZ    = prefs.timezone || "Asia/Tokyo";

/* ============================================================
   ヘッダー要素
============================================================ */
const segCalendar = document.getElementById("segCalendar");
const segTodo     = document.getElementById("segTodo");
const calendarPage = document.getElementById("calendarPage");
const todoPage     = document.getElementById("todoPage");
const modeToggle   = document.getElementById("modeToggle");
const tzButton     = document.getElementById("tzButton");
const tzSelect     = document.getElementById("tzSelect");

/* ============================================================
   タイムゾーン選択
============================================================ */
(function setupTimezones() {
  const zones = Intl.supportedValuesOf("timeZone");
  zones.forEach(tz => {
    const op = document.createElement("option");
    op.value = tz;
    op.textContent = tz;
    tzSelect.appendChild(op);
  });
  tzSelect.value = currentTZ;
  tzButton.textContent = currentTZ;
})();

/* ============================================================
   日時表示
============================================================ */
function updateNow() {
  const now = new Date();
  document.getElementById("heroTime").textContent =
    now.toLocaleTimeString("ja-JP", { hour:"2-digit", minute:"2-digit", timeZone: currentTZ });
  document.getElementById("heroDate").textContent =
    now.toLocaleDateString("ja-JP", {
      year:"numeric", month:"2-digit", day:"2-digit", weekday:"short", timeZone: currentTZ
    });
}
updateNow();
setInterval(updateNow, 30000);

/* タイムゾーン変更 */
tzSelect.addEventListener("change", () => {
  currentTZ = tzSelect.value;
  tzButton.textContent = currentTZ;
  prefs.timezone = currentTZ;
  savePrefs(prefs);
  updateNow();
});

/* ============================================================
   時刻文字列 → 分
============================================================ */
function parseTimeToMinutes(t) {
  if (!t) return null;
  const parts = t.split(":");
  if (parts.length !== 2) return null;
  const h = Number(parts[0]);
  const m = Number(parts[1]);
  if (Number.isNaN(h) || Number.isNaN(m)) return null;
  return h * 60 + m;
}

/* ============================================================
   月カレンダー描画（1マス3行）
============================================================ */
function renderCalendar() {
  const grid = document.getElementById("calendarGrid");
  const monthLabel = document.getElementById("monthLabel");

  grid.innerHTML = "";
  monthLabel.textContent = `${viewYear}年${viewMonth + 1}月`;

  const first = new Date(viewYear, viewMonth, 1);
  const last  = new Date(viewYear, viewMonth + 1, 0);

  const events = loadEvents();
  const todayStr = new Date().toISOString().slice(0,10);

  for (let i = 0; i < first.getDay(); i++) {
    const blank = document.createElement("div");
    blank.className = "day-cell";
    blank.style.visibility = "hidden";
    grid.appendChild(blank);
  }

  for (let d = 1; d <= last.getDate(); d++) {
    const dateStr = `${viewYear}-${String(viewMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dayEvents = events.filter(ev => ev.start === dateStr);

    const cell = document.createElement("div");
    cell.className = "day-cell";

    if (dateStr === todayStr) {
      cell.classList.add("day-cell-today");
    }
    if (dateStr === selectedDate) {
      cell.classList.add("selected");
    }

    const num = document.createElement("div");
    num.className = "day-number";
    num.textContent = d;
    cell.appendChild(num);

    dayEvents.slice(0,3).forEach(ev => {
      const line = document.createElement("div");
      line.className = "event-line";
      line.style.background = ev.color || "#3478F6";
      line.textContent = ev.title || "(無題)";
      cell.appendChild(line);
    });

    if (dayEvents.length > 3) {
      const more = document.createElement("div");
      more.className = "event-line";
      more.style.background = "rgba(0,0,0,0.4)";
      more.textContent = `+${dayEvents.length - 3}件`;
      cell.appendChild(more);
    }

    cell.addEventListener("click", () => {
      selectedDate = dateStr;
      prefs.selectedDate = selectedDate;
      prefs.viewYear = viewYear;
      prefs.viewMonth = viewMonth;
      savePrefs(prefs);
      renderCalendar();
      renderSelectedDay();
      renderDayView();
    });

    grid.appendChild(cell);
  }
}

/* ============================================================
   日ビュー（タイムライン）
============================================================ */
function renderDayView() {
  const label = document.getElementById("dayViewLabel");
  const hoursLayer = document.getElementById("dayHours");
  const eventsLayer = document.getElementById("dayEventsLayer");

  label.textContent = `${selectedDate} のタイムライン`;
  hoursLayer.innerHTML = "";
  eventsLayer.innerHTML = "";

  for (let h = 0; h < 24; h++) {
    const lab = document.createElement("div");
    lab.className = "day-hour-label";
    lab.style.top = (h / 24 * 100) + "%";
    lab.textContent = `${String(h).padStart(2,"0")}:00`;
    hoursLayer.appendChild(lab);
  }

  const events = loadEvents().filter(ev => ev.start === selectedDate);

  events.forEach(ev => {
    let startMin = parseTimeToMinutes(ev.startTime);
    let endMin   = parseTimeToMinutes(ev.endTime);

    if (startMin == null && endMin == null) {
      startMin = 9 * 60;
      endMin   = 10 * 60;
    } else if (startMin == null) {
      startMin = Math.max(endMin - 60, 0);
    } else if (endMin == null) {
      endMin = startMin + 60;
    }
    if (endMin <= startMin) endMin = startMin + 30;

    const top    = (startMin / 1440) * 100;
    const height = Math.max((endMin - startMin) / 1440 * 100, 4);

    const block = document.createElement("div");
    block.className = "day-event-block";
    block.style.top = top + "%";
    block.style.height = height + "%";
    block.style.background = ev.color || "#3478F6";

    const timeLabel =
      (ev.startTime || "") +
      (ev.endTime ? (" - " + ev.endTime) : "");

    block.textContent = `${timeLabel} ${ev.title || "(無題)"}`;
    eventsLayer.appendChild(block);
  });
}

/* ============================================================
   左側：選択日の予定編集
============================================================ */
function renderSelectedDay() {
  const list = document.getElementById("noteList");
  const label = document.getElementById("selectedDateLabel");
  label.textContent = `${selectedDate} の予定`;

  const events = loadEvents().filter(ev => ev.start === selectedDate);

  events.sort((a,b) => {
    const am = parseTimeToMinutes(a.startTime) ?? 0;
    const bm = parseTimeToMinutes(b.startTime) ?? 0;
    return am - bm;
  });

  list.innerHTML = "";

  events.forEach(ev => {
    const card = document.createElement("div");
    card.className = "note-card";

    const sTime = ev.startTime || "";
    const eTime = ev.endTime   || "";

    card.innerHTML = `
      <div class="note-row">
        <input type="time" value="${sTime}">
        <input type="time" value="${eTime}">
      </div>
      <div class="note-row">
        <input type="text" value="${ev.title}" placeholder="タイトル">
      </div>
      <div class="note-row">
        <input type="color" value="${ev.color}">
      </div>
      <div class="note-row">
        <input type="text" value="${ev.location.name}" placeholder="場所">
        <button type="button" class="map-open">地図</button>
      </div>
      <button class="note-delete">削除</button>
    `;

    const timeInputs = card.querySelectorAll("input[type='time']");
    const titleInput = card.querySelectorAll("input[type='text']")[0];
    const placeInput = card.querySelectorAll("input[type='text']")[1];
    const colorInput = card.querySelector("input[type='color']");
    const mapBtn     = card.querySelector(".map-open");
    const delBtn     = card.querySelector(".note-delete");

    timeInputs[0].addEventListener("input", e => {
      ev.startTime = e.target.value;
      saveUpdate(ev);
    });

    timeInputs[1].addEventListener("input", e => {
      ev.endTime = e.target.value;
      saveUpdate(ev);
    });

    titleInput.addEventListener("input", e => {
      ev.title = e.target.value;
      saveUpdate(ev);
    });

    colorInput.addEventListener("input", e => {
      ev.color = e.target.value;
      saveUpdate(ev);
    });

    placeInput.addEventListener("input", e => {
      ev.location.name = e.target.value;
      saveUpdate(ev);
    });

    mapBtn.addEventListener("click", () => {
      const q = ev.location.name.trim();
      if (!q) return;
      const url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(q);
      window.open(url, "_blank");
    });

    delBtn.addEventListener("click", () => {
      removeEvent(ev.id);
    });

    list.appendChild(card);
  });
}

/* 更新 */
function saveUpdate(ev) {
  const all = loadEvents();
  const idx = all.findIndex(x => x.id === ev.id);
  if (idx !== -1) {
    all[idx] = ev;
    saveEvents(all);
    renderCalendar();
    renderDayView();
  }
}

/* 削除 */
function removeEvent(id) {
  const all = loadEvents().filter(ev => ev.id !== id);
  saveEvents(all);
  renderSelectedDay();
  renderCalendar();
  renderDayView();
}

/* 追加（選択日） */
document.getElementById("addNoteBtn").addEventListener("click", () => {
  const ev = createEvent();
  ev.start = selectedDate;
  ev.startTime = "09:00";
  ev.endTime   = "10:00";
  const all = loadEvents();
  all.push(ev);
  saveEvents(all);
  renderSelectedDay();
  renderCalendar();
  renderDayView();
});

/* ============================================================
   月移動 / Today
============================================================ */
document.getElementById("prevMonth").addEventListener("click", () => {
  viewMonth--;
  if (viewMonth < 0) {
    viewMonth = 11;
    viewYear--;
  }
  prefs.viewYear = viewYear;
  prefs.viewMonth = viewMonth;
  savePrefs(prefs);
  renderCalendar();
});

document.getElementById("nextMonth").addEventListener("click", () => {
  viewMonth++;
  if (viewMonth > 11) {
    viewMonth = 0;
    viewYear++;
  }
  prefs.viewYear = viewYear;
  prefs.viewMonth = viewMonth;
  savePrefs(prefs);
  renderCalendar();
});

document.getElementById("todayBtn").addEventListener("click", () => {
  const now = new Date();
  viewYear = now.getFullYear();
  viewMonth = now.getMonth();
  selectedDate = now.toISOString().slice(0,10);
  prefs.viewYear = viewYear;
  prefs.viewMonth = viewMonth;
  prefs.selectedDate = selectedDate;
  savePrefs(prefs);
  renderCalendar();
  renderSelectedDay();
  renderDayView();
});

/* ============================================================
   過去 / 未来の予定ジャンプ（日単位）
============================================================ */
function jumpToEvent(direction) {
  const all = loadEvents().filter(ev => ev.start).map(ev => ev.start);
  if (!all.length) return;
  const uniqueDates = Array.from(new Set(all)).sort();

  const idx = uniqueDates.indexOf(selectedDate);
  if (direction === "prev") {
    let target = null;
    for (let i = (idx === -1 ? uniqueDates.length : idx) - 1; i >= 0; i--) {
      if (uniqueDates[i] < selectedDate) {
        target = uniqueDates[i];
        break;
      }
    }
    if (!target) return;
    selectedDate = target;
  } else {
    let target = null;
    for (let i = idx + 1; i < uniqueDates.length; i++) {
      if (uniqueDates[i] > selectedDate) {
        target = uniqueDates[i];
        break;
      }
    }
    if (!target) return;
    selectedDate = target;
  }

  const [y,m] = selectedDate.split("-").map(Number);
  viewYear = y;
  viewMonth = m - 1;

  prefs.selectedDate = selectedDate;
  prefs.viewYear = viewYear;
  prefs.viewMonth = viewMonth;
  savePrefs(prefs);

  renderCalendar();
  renderSelectedDay();
  renderDayView();
}

document.getElementById("prevEventBtn").addEventListener("click", () => {
  jumpToEvent("prev");
});
document.getElementById("nextEventBtn").addEventListener("click", () => {
  jumpToEvent("next");
});

/* ============================================================
   ダークモード（保存付き）
============================================================ */
if (prefs.dark) {
  document.body.classList.add("dark");
  modeToggle.textContent = "Light";
}

modeToggle.addEventListener("click", () => {
  const isDark = document.body.classList.toggle("dark");
  modeToggle.textContent = isDark ? "Light" : "Dark";
  prefs.dark = isDark;
  savePrefs(prefs);
});

/* ============================================================
   CALENDAR / TODO 切り替え（セグメント＋フェード＋保存）
============================================================ */
function showCalendar() {
  calendarPage.style.display = "block";
  todoPage.style.display = "none";
  calendarPage.style.opacity = "1";
  segCalendar.classList.add("active");
  segTodo.classList.remove("active");
  prefs.page = "CALENDAR";
  savePrefs(prefs);
}

function showTodo() {
  calendarPage.style.display = "none";
  todoPage.style.display = "block";
  todoPage.style.opacity = "1";
  segCalendar.classList.remove("active");
  segTodo.classList.add("active");
  prefs.page = "TODO";
  savePrefs(prefs);
}

segCalendar.addEventListener("click", () => {
  calendarPage.style.opacity = "0";
  setTimeout(showCalendar, 200);
});

segTodo.addEventListener("click", () => {
  todoPage.style.opacity = "0";
  setTimeout(showTodo, 200);
});

/* 初期ページ */
if (prefs.page === "TODO") {
  showTodo();
} else {
  showCalendar();
}

/* ============================================================
   ToDo：保存・チェック・削除・並び替え
============================================================ */
const todoList = document.getElementById("todoList");
const addTodoBtn = document.getElementById("addTodoBtn");

function renderTodo() {
  const todos = loadTodo();
  todoList.innerHTML = "";

  todos.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "todo-item";
    div.setAttribute("draggable","true");

    div.innerHTML = `
      <input type="checkbox" ${item.done ? "checked":""}>
      <input type="text" value="${item.text || ""}">
      <button class="todo-delete">✕</button>
    `;

    const chk = div.querySelector("input[type='checkbox']");
    const txt = div.querySelector("input[type='text']");
    const del = div.querySelector(".todo-delete");

    chk.addEventListener("change", e => {
      todos[index].done = e.target.checked;
      saveTodo(todos);
    });

    txt.addEventListener("input", e => {
      todos[index].text = e.target.value;
      saveTodo(todos);
    });

    del.addEventListener("click", () => {
      todos.splice(index,1);
      saveTodo(todos);
      renderTodo();
    });

    div.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", index);
    });

    div.addEventListener("dragover", e => {
      e.preventDefault();
    });

    div.addEventListener("drop", e => {
      const from = Number(e.dataTransfer.getData("text/plain"));
      const to = index;
      const arr = loadTodo();
      const moved = arr.splice(from,1)[0];
      arr.splice(to,0,moved);
      saveTodo(arr);
      renderTodo();
    });

    todoList.appendChild(div);
  });
}

addTodoBtn.addEventListener("click", () => {
  const todos = loadTodo();
  todos.push({ text:"", done:false });
  saveTodo(todos);
  renderTodo();
});

/* ============================================================
   初期描画
============================================================ */
renderCalendar();
renderSelectedDay();
renderDayView();
renderTodo();
</script>

</body>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyC4BMeBCBgr4HV52JRn31m3qkKy8OdqZ_c",
    authDomain: "apple-calendar-clone.firebaseapp.com",
    projectId: "apple-calendar-clone",
    storageBucket: "apple-calendar-clone.firebasestorage.app",
    messagingSenderId: "263484519350",
    appId: "1:263484519350:web:cd5b22e8a5a5a32d1c0717",
    measurementId: "G-FSX2TJV685"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</html>
